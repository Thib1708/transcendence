{% extends 'base.html' %}

{% block css %}
{% load static %}
<link rel="stylesheet" href="{% static 'pong_app/css/style.css' %}">
{% endblock %}

{% block title %}
Chat Room
{% endblock %}

{% block content %}

<div>
	<div id="chat-log"></div><br>
	<input id="chat-message-input" type="text" size="100"><br>
	<input id="chat-message-submit" type="button" value="Send">
</div>

{{ room_name|json_script:"room-name" }}
<script>
	const roomName = JSON.parse(document.getElementById('room-name').textContent);

	let		websocketProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
	let		websocketPort = window.location.protocol === 'https:' ? '' : '';
	const	socketUrl = websocketProtocol + '//' + window.location.host + websocketPort + '/ws/chat/' + roomName + "/";
	const	chatSocket = new WebSocket(socketUrl);

	chatSocket.onmessage = function(e) {
		const data = JSON.parse(e.data);
		const messageContainer = document.createElement('p');
		messageContainer.textContent = data.sender + " : " + data.message;
		document.querySelector('#chat-log').appendChild(messageContainer);
	};

	chatSocket.onclose = function(e) {
		console.error('Chat socket closed unexpectedly');
	};

	document.querySelector('#chat-message-input').focus();
	document.querySelector('#chat-message-input').onkeyup = function(e) {
		if (e.key === 'Enter') {  // enter, return
			document.querySelector('#chat-message-submit').click();
		}
	};

	document.querySelector('#chat-message-submit').onclick = function(e) {
		const messageInputDom = document.querySelector('#chat-message-input');
		const message = messageInputDom.value;
		if (!message)
		  return;
		const sender = "{{ request.user.username }}";
		const messageContainer = document.createElement('p');
		messageContainer.textContent = sender + " : " + message;
		document.querySelector('#chat-log').appendChild(messageContainer);
		chatSocket.send(JSON.stringify({
		  'message': message,
		  'sender': sender
		}));
		messageInputDom.value = '';
	};
</script>

{% endblock %}